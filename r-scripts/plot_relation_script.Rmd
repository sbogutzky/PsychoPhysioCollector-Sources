```{r user-input}
  rm(list = ls(all = T))
  path.dropbox              <- "/Users/simonbogutzky/Dropbox/"
  path.activity             <- "running/" 
  path.person               <- "buse-patrick/"

  activity                  <- "Running"
  sex                       <- "Male"
  age                       <- "29"
  subsets.total             <- 4
  subset.to.last.minutes    <- 10

  band.range.ulf            <- c(0, .0033)
  band.range.vlf            <- c(.0033, .06)
  band.range.lf             <- c(.06, .14)
  band.range.hf             <- c(.15, .499)
  band.range.vhf            <- c(.499, .5)
```

```{r functions}
  source("./functions.R")
```

```{r plot-relation}
  directories <- list.dirs(path = paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, sep = ""), recursive = F)

  data.matrix <- data.frame()
  for (directory in directories) {
    
    # extract fss factors
      file.path   <- paste(directory, "/", "scale.csv", sep ="")
      scale.items <- read.csv(file.path)
      fss.factors <- CalculateFlowShortScaleFactors(scale.items)

    for (subset in 1:subsets.total) {
    
    # extract rr intervals and psd values 
      file.path     <- paste(directory, "/", "subset-", subset, "/hrv-data.txt", sep ="")
      
      if(file.exists(file.path)) {
      
      # extract hrv parameters
        data.kubios.hrv <- read.csv(file.path, header = F, na.strings = "", fill = T, skip = 97, col.names = c("NA1", "Time", "RRInterval", "FFTFrequency", "FFTPSD", "ARFrequency", "ARPSD", "NA2", "NA3", "NA4", "NA5"))
        
        # Times in seconds
      times           <- data.kubios.hrv$Time
      times           <- times[!is.na(times)]
      
      # RR intervals in seconds
      rr.intervals    <- data.kubios.hrv$RRInterval
      rr.intervals    <- rr.intervals[!is.na(rr.intervals)]
      
      # Subset data
      in.time         <- times > times[length(times)] - subset.to.last.minutes * 60
      times           <- times[in.time]
      rr.intervals    <- rr.intervals[in.time]
        
        hrv.frequency.domain.parameters <- CalculateHRVFrequencyDomainParameters(times, rr.intervals, band.range.ulf, band.range.vlf, band.range.lf, band.range.hf, band.range.vhf, "peifer", 5) 
        
      # add data to data matrix
        data.matrix <- rbind(data.matrix, cbind(fss.factors[subset,], hrv.frequency.domain.parameters, subset = subset))
      }
    }
  }

  # data.table <- subset(data.matrix, select = c("subset", "flow", "fluency", "absorption", "anxiety", "fit", "meanhr", "lfpowfft", "hfpowfft", "totpowfft", "lfhffft", "lfpownufft", "hfpownufft"))
  # colnames(data.table) <- c("Subset", "Flow", "Fluency", "Absorption", "Anxiety", "Fit", "Mean HR", "LF Power (FFT)", "HF Power (FFT)", "Total Power (FFT)", "LF/HF (FFT)", "LF Power (FFT) n. u", "HF Power (FFT) n. u")
  # rownames(data.table) <- c(as.character(as.POSIXct(data.matrix[, 1] / 1000, tz = "Europe/Berlin", origin = "1970-01-01")))
  # data.table <- as.table(data.table)
  # data.table

# plot relation
  loadfonts()
  file.path     <- paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, "absorption-hrv-relation.pdf", sep = "")
  
  pdf(file.path, width = 14.2191, height = 10.6643, family = "Gill Sans MT")
  par(mfrow = c(2, 1), mar = c(7.1, 5.1, 4.1, 1.1), oma = c(0, 0, 0, 0), mgp = c(3, 1, 0))    
  
  PlotRelation(data.matrix$lfpowfft, data.matrix$absorption, main = "", xlab =  expression("Power of LF band " (ms^2)), ylab = "Absorption", ylim = c(2, 7), pch = 21, bg = "#3FADCB", cex = 2, cex.lab = 2, cex.axis = 1.5)

  #text(data.matrix$lfpowfft, data.matrix$absorption, as.POSIXct(data.matrix$timestamp / 1000, origin = "1970-01-01"), cex = 0.5, pos = 1, col = "black")
  
  title(main = paste("Activity: ", activity, ", Sex: ", sex, ", Age: ", age, sep = ""), cex.main = 3)

  PlotRelation(data.matrix$hfpowfft, data.matrix$absorption, main = "", xlab = expression("Power of HF band " (ms^2)), ylab = "Absorption", ylim = c(2, 7), pch = 21, bg = "#3FADCB", cex = 2, cex.lab = 2, cex.axis = 1.5)
  #text(data.matrix$hfpowfft, data.matrix$absorption, as.POSIXct(data.matrix$timestamp / 1000, origin = "1970-01-01"), cex = 0.5, pos = 1, col = "black")

dev.off()
```