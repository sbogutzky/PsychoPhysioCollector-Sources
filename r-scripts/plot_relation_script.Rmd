```{r user-input}
  rm(list = ls(all = T))
  path.dropbox              <- "/Dropbox/"
  path.activity             <- "activity/" 
  path.person               <- "lastname-firstname/"

  activity                  <- "Activity"
  sex                       <- "Sex"
  age                       <- "xx"
  subsets.total             <- 4

  band.range.ulf            <- c(0, .0033)
  band.range.vlf            <- c(.0033, .04)
  band.range.lf             <- c(.04, .15)
  band.range.hf             <- c(.15, .4)
  band.range.vhf            <- c(.4, .5)
```

```{r functions}
  source("./functions.R")
```

```{r plot-relation}
  directories <- list.dirs(path = paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, sep = ""), recursive = F)

  data.matrix <- data.frame()
  for (directory in directories) {
    
    # extract fss factors
      file.path   <- paste(directory, "/", "scale.csv", sep ="")
      scale.items <- read.csv(file.path)
      fss.factors <- CalculateFlowShortScaleFactors(scale.items)

    for (subset in 1:subsets.total) {
    
    # extract rr intervals and psd values 
      file.path     <- paste(directory, "/", "subset-", subset, "/hrv-data.txt", sep ="")
      
      if(file.exists(file.path)) {
      
      # extract hrv parameters
        data.kubios.hrv <- read.csv(file.path, header = F, na.strings = "", fill = T, skip = 97, col.names = c("NA1", "Time", "RRInterval", "FFTFrequency", "FFTPSD", "ARFrequency", "ARPSD", "NA2", "NA3", "NA4", "NA5"))
        
        # Times in seconds
      times           <- data.kubios.hrv$Time
      times           <- times[!is.na(times)]
      
      # RR intervals in seconds
      rr.intervals    <- data.kubios.hrv$RRInterval
      rr.intervals    <- rr.intervals[!is.na(rr.intervals)]
        
        hrv.frequency.domain.parameters <- CalculateHRVFrequencyDomainParameters(times, rr.intervals, band.range.ulf, band.range.vlf, band.range.lf, band.range.hf, band.range.vhf, "welch", 4, 256, .5) 
        
      # add data to data matrix
        data.matrix <- rbind(data.matrix, cbind(fss.factors[subset,], hrv.frequency.domain.parameters, subset = subset))
      }
    }
  }

  # data.table <- subset(data.matrix, select = c("subset", "flow", "fluency", "absorption", "anxiety", "fit", "meanhr", "lfpowfft", "hfpowfft", "totpowfft", "lfhffft", "lfpownufft", "hfpownufft"))
  # colnames(data.table) <- c("Subset", "Flow", "Fluency", "Absorption", "Anxiety", "Fit", "Mean HR", "LF Power (FFT)", "HF Power (FFT)", "Total Power (FFT)", "LF/HF (FFT)", "LF Power (FFT) n. u", "HF Power (FFT) n. u")
  # rownames(data.table) <- c(as.character(as.POSIXct(data.matrix[, 1] / 1000, tz = "Europe/Berlin", origin = "1970-01-01")))
  # data.table <- as.table(data.table)
  # data.table

# plot relation
  file.path     <- paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, "flow-hrv-relation-sb.pdf", sep = "")
  pdf(file.path, width = 11, height = 8, paper = "a4")
      
  par(mfrow = c(2, 1))
  PlotRelation(data.matrix$lfpowfft, data.matrix$flow, main = "", xlab =  expression("Power LF-Band " (ms^2)), ylab = "Flow", ylim = c(2, 7), pch = 20)

  text(data.matrix$lfpowfft, data.matrix$flow, as.POSIXct(data.matrix$timestamp / 1000, origin = "1970-01-01"), cex = 0.5, pos = 1, col = terrain.colors(6)[2])
  
  title(main = paste("Relation - Activity: ", activity, ", Sex: ", sex, ", Age: ", age, sep = ""))
  
  PlotRelation(data.matrix$hfpowfft, data.matrix$flow, main = "", xlab = expression("Power HF-Band " (ms^2)), ylab = "Flow", ylim = c(2, 7), pch = 20)

  text(data.matrix$hfpowfft, data.matrix$flow, as.POSIXct(data.matrix$timestamp / 1000, origin = "1970-01-01"), cex = 0.5, pos = 1, col = terrain.colors(6)[2])

  dev.off()
```