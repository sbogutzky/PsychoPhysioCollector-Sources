```{r user-input}
  rm(list = ls(all = T))
  path.dropbox              <- "/Users/simonbogutzky/Dropbox/"
  path.activity             <- "running/" 
  path.person               <- "bogutzky-simon/"
  path.date                 <- "2014-05-22_17-12-49/"

  activity                  <- "Running"
  sex                       <- "Male"
  age                       <- "30"

  subsets.total             <- 4
  subsets.internal          <- 3
  length.subsets.internal   <- 5
  
  band.range.ulf            <- c(0, .0033)
  band.range.vlf            <- c(.0033, .04)
  band.range.lf             <- c(.04, .15)
  band.range.hf             <- c(.15, .4)
  band.range.vhf            <- c(.4, .5)

  range.amplitudes          <- c(0, 500 / 10^6)
  range.frequencies         <- c(0, .5)
  range.rr.intervals        <- c(.4, .7)
```

```{r functions}
  source("./functions.R")
```

```{r plot-rr-intervals-and-psd}

  data.hrv.flow <- data.frame()
  for (subset in 1:subsets.total) {
  print(subset)
  # extract fss factors
    file.path   <- paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, path.date, "scale.csv", sep ="")
    fss.items <- read.csv(file.path)
    fss.factors <- CalculateFlowShortScaleFactors(fss.items)
  
  # extract rr intervals and psd values 
    file.path       <- paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, path.date, "subset-", subset, "/hrv-data.txt", sep ="")
    
    if(file.exists(file.path)) {
  
      data.kubios.hrv <- read.csv(file.path, header = F, na.strings = "", fill = T, skip = 97, col.names = c("NA1", "Time", "RRInterval", "FFTFrequency", "FFTPSD", "ARFrequency", "ARPSD", "NA2", "NA3", "NA4", "NA5"))
      
      # Times in seconds
      times           <- data.kubios.hrv$Time
      times           <- times[!is.na(times)]
      
      # RR intervals in seconds
      rr.intervals    <- data.kubios.hrv$RRInterval
      rr.intervals    <- rr.intervals[!is.na(rr.intervals)]
      
      # plot rr intervals and psd
      date.end <- fss.factors[subset, ]$timestamp / 1000
      date.start <- (date.end - times[length(times)])
      
      time.start <- times[1]
      
      for (internal.subset in 1:subsets.internal) {
        
        # Times in seconds
        time.end        <- time.start + length.subsets.internal * 60 
        indexes.subset  <- times >= time.start & times <= time.end
        
        times.subset        <- times[indexes.subset]
        rr.intervals.subset <- rr.intervals[indexes.subset]
      
file.path     <- paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, substr(path.date, 1, 19), "-", "subset-", subset, "-", internal.subset, "-rr-intervals-and-psd.pdf", sep ="")
pdf(file.path, width = 11, height = 8, paper = "a4r")
    
        par(mfrow = c(2, 1), mar = c(5.1, 5.1, 4.1, 2.1))
      
        plot(times.subset, rr.intervals.subset, type = "l", xlab = "Time (s)", ylab = "RR Interval (s)", xaxs = "i", yaxs = "i", xaxt = "n", ylim = range.rr.intervals)
        title(main = paste("Tachogram - Activity: ", activity, ", Sex: ", sex, ", Age: ", age, ", Subset ", subset, "/",  subsets.total, " - ", internal.subset, sep = ""), sub = paste("Start: ", as.POSIXct(date.start, tz = "Europe/Berlin", origin = "1970-01-01"), ", End: ", as.POSIXct(date.end, tz = "Europe/Berlin", origin = "1970-01-01"), sep = ""))
        axis(side = 1, at = seq(0, 900, by = 60))
        axis(side = 3, at = max(times), labels = paste("Flow:", fss.factors$flow[subset]))
  
        hrv.frequency.domain.parameters <- CalculateHRVFrequencyDomainParameters(times.subset, rr.intervals.subset, band.range.ulf, band.range.vlf, band.range.lf, band.range.hf, band.range.vhf, 4, 256, .5, T, range.frequencies, range.amplitudes)      
dev.off()

        time.start <- time.end
        
        flow <- NA
        if(internal.subset == subsets.internal) {
          flow <- fss.factors$flow[subset]
        }

        data.hrv.flow <- rbind(data.hrv.flow, cbind(hrv.frequency.domain.parameters, flow))
      }
    }
  }
```

```{r hrv-parameter-history-against-flow}

  file.path     <- paste(path.dropbox, "data-flow/final-data/", path.activity, path.person, substr(path.date, 1, 19), "-bands-and-flow.pdf", sep ="")
  pdf(file.path, width = 11, height = 8, paper = "a4r")

  PlotFlow <- function() {
    par(new = T)
    plot(data.hrv.flow$flow, col = terrain.colors(6)[2], axes = F, xlab = NA, ylab = NA, type = "o", pch = 19)
    axis(side = 4, col = terrain.colors(6)[2])
    mtext(side = 4, line = 3, "flow", col = terrain.colors(6)[2])
  }
  
  par(mfrow = c(4, 1), mar = c(5.1, 5.1, 4.1, 5.1))
  
  plot(data.hrv.flow$vlfpowfft, type = "o", xlab = "Measurement (n)", ylab = expression(VLF~(ms^2)), ylim = c(0, 1200), pch = 19)
  PlotFlow()
  
  plot(data.hrv.flow$lfpowfft, type = "o", xlab = "Measurement (n)", ylab = expression(LF~(ms^2)), ylim = c(0, 10), pch = 19)
  PlotFlow()

  plot(data.hrv.flow$hfpowfft, type = "o", xlab = "Measurement (n)", ylab = expression(HF~(ms^2)), ylim = c(0, 10), pch = 19)
  PlotFlow()

  plot(data.hrv.flow$lfhffft, type = "o", xlab = "Measurement (n)", ylab = "LF/HF", ylim = c(0, 5), pch = 19)
  PlotFlow()

  dev.off()
```