```{r user-input}
  rm(list = ls(all = T))
  dropbox.path              <- "/Users/simonbogutzky/Dropbox/"
  activity.path             <- "running/" 
  person.path               <- "bogutzky-simon/"
  date.path                 <- "2014-05-22_17-12-49/"

  activity        <- "Running"
  sex             <- "Male"
  age             <- "30"
  total.subsets   <- 4

  band.vlf      <- c(0, 0.04)
  band.lf       <- c(0.04, 0.15)
  band.hf       <- c(0.15, 0.4)

  amplitude.range       <- c(0, 1000 / 10^6)
  frequency.range       <- c(.0033, .5)
  rr.interval.range     <- c(.4, .7)
```

```{r functions}
  source("./functions.R")
```

```{r plot-rr-intervals-and-psd}
  for (subset in 1:total.subsets) {
  print(subset)
  # extract fss factors
    file.path   <- paste(dropbox.path, "data-flow/final-data/", activity.path, person.path, date.path, "scale.csv", sep ="")
    scale.items <- read.csv(file.path)
    fss.factors <- CalculateFlowShortScaleFactors(scale.items)
  
  # extract rr intervals and psd values 
    file.path       <- paste(dropbox.path, "data-flow/final-data/", activity.path, person.path, date.path, "subset-", subset, "/hrv-data.txt", sep ="")
    
    if(file.exists(file.path)) {
  
      kubios.hrv.data <- read.csv(file.path, header = F, na.strings = "", fill = T, skip = 97, col.names = c("NA1", "Time", "RRInterval", "FFTFrequency", "FFTPSD", "ARFrequency", "ARPSD", "NA2", "NA3", "NA4", "NA5"))
      
      # Times in seconds
      times           <- kubios.hrv.data$Time
      times           <- times[!is.na(times)]
      
      # RR intervals in seconds
      rr.intervals    <- kubios.hrv.data$RRInterval
      rr.intervals    <- rr.intervals[!is.na(rr.intervals)]
      
      # plot rr intervals and psd
      date.end <- fss.factors[subset, ]$timestamp / 1000
      date.start <- (date.end - times[length(times)])
      
#       file.path     <- paste(dropbox.path, "data-flow/final-data/", activity.path, person.path, substr(date.path, 1, 19), "-", "subset-", subset, "-rr-intervals-and-psd.pdf", sep ="")
#       pdf(file.path, width = 11, height = 8, paper = "a4r")
    
      par(mfrow = c(2, 1))
    
      plot(times, rr.intervals, type = "l", xlab = "Time (s)", ylab = "RR Interval (s)", xaxs = "i", yaxs = "i", xaxt = "n", ylim = rr.interval.range)
      title(main = paste("Tachogram - Activity: ", activity, ", Sex: ", sex, ", Age: ", age, ", Subset ", subset, "/",  total.subsets, sep = ""), sub = paste("Start: ", as.POSIXct(date.start, tz = "Europe/Berlin", origin = "1970-01-01"), ", End: ", as.POSIXct(date.end, tz = "Europe/Berlin", origin = "1970-01-01"), sep = ""))
      axis(side = 1, at = seq(0, 900, by = 60))
      axis(side = 3, at = max(times), labels = paste("Flow:", fss.factors$flow[subset]))

      hrv.frequency.domain.parameters <- CalculateHRVFrequencyDomainParameters(times, rr.intervals, band.vlf, band.lf, band.hf, 4, 256, .5, T)
    
      #legend("topright", title = "Frequency bands", c("VLF", paste("LF: ", round(spss.hrv.data$lfpowfft, 1), " ms^2"), paste("HF: ", round(spss.hrv.data$hfpowfft, 1), " ms^2"), "VHF", paste("LF/HF: ", round(spss.hrv.data$lfhffft, 1))), fill = terrain.colors(5), inset = .05, cex = .7)
    
      #dev.off()
  
    }
  }
```